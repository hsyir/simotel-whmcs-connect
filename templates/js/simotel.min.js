const adminPanelUrl=window.panelWebUrl,addonUrl=window.addonUrl,channelName=window.channelName,popUpTime=window.popUpTime,popUpTimeMilliSeconds=1e3*popUpTime,phoneNumberRegx=window.phoneNumberRegx,callerIdPopUpActive=window.callerIdPopUpActive,clickToDialActive=window.clickToDialActive,selectedPopUpButtons=window.selectedPopUpButtons;if(window.callerIdPopUpActive){var pusherOptions={useTLS:!0,cluster:app_cluster,wsHost:wsHost,wsPort:wsPort,wssPort:wsPort,disableStats:!0,enabledTransports:["ws","wss"],authEndpoint:auth_endpoint};new Pusher(app_key,pusherOptions).subscribe(channelName).bind("CallerId",callerId)}function callerId(e){let t,n,i,o=e.client;if(o){t=$("<div>"),i=$("<a>").attr("href",`${adminPanelUrl}/clientssummary.php?userid=${o.id}`).html(`<strong> ${o.fullname}</strong>`),$(t).append($("<div class='clientName'>").append(i));let s=$("<a>").attr("href",`${adminPanelUrl}/clientssummary.php?userid=${o.id}`).html(` ${o.companyname}`);o.hasOwnProperty("companyname")&&$(t).append($("<div class='clientCompany'>").append(s)),n=$("<a>").attr("href",`tel:${e.participant}`).html(`<strong> ${e.participant}</strong>`),$(t).append($("<div class='clientTell'>").append(n));const l=30;if(o.notes)if(o.notes.length>l){let e=$("<span>").click(function(){$(this).html(o.notes)}).html(o.notes.slice(0,l)+"<a class='readMoreDots'> <span class='bracket'>[</span>...<span class='bracket'>]</span> </a>"),n=$("<div>").html("<strong>یادداشت: </strong>").append(e);$(t).append($("<div class='clientNotes'>").append(n))}else{let e=$("<div>").html(`<strong>یادداشت: </strong>${o.notes}`);$(t).append($("<div class='clientNotes'>").append(e))}$(t).append($("<div class='clrfx'>"));let a={view_profile:{url:`${adminPanelUrl}/clientssummary.php?userid=${o.id}`,caption:"مشاهده پروفایل"},edit_profile:{url:`${adminPanelUrl}/clientsprofile.php?userid=${o.id}`,caption:"ویرایش پروفایل"},services:{url:`${adminPanelUrl}/clientsservices.php?userid=${o.id}`,caption:"سرویس ها"},domains:{url:`${adminPanelUrl}/clientsdomains.php?userid=${o.id}`,caption:"دامنه ها"},notes:{url:`${adminPanelUrl}/clientsnotes.php?userid=${o.id}`,caption:"یادداشت ها"},tickets:{url:`${adminPanelUrl}/client/${o.id}/tickets`,caption:"تیکت ها"},transactions:{url:`${adminPanelUrl}/clientstransactions.php?userid=${o.id}`,caption:"تراکنش ها"},factors:{url:`${adminPanelUrl}/clientsinvoices.php?userid=${o.id}`,caption:"فاکتور ها"},pre_factors:{url:`${adminPanelUrl}/clientsquotes.php?userid=${o.id}`,caption:"پیش فاکتور ها"},create_ticket:{url:`${adminPanelUrl}/supporttickets.php?action=open&userid=${o.id}`,caption:"ایجاد تیکت"},create_factor:{url:`${adminPanelUrl}/clientssummary.php?userid=${o.id}`,caption:"ایجاد فاکتور"},create_pre_factor:{url:`${adminPanelUrl}/quotes.php?action=manage&userid=${o.id}`,caption:"ایجاد پیش فاکتور"},view_bill:{url:`${adminPanelUrl}/reports.php?report=client_statement&userid=${o.id}`,caption:"صورت حساب"}},r=$("<div>");$(r).append($("<div class='simotelBtns'>")),selectedPopUpButtons.forEach(e=>{if(a.hasOwnProperty(e)){let t=$("<a>").attr("href",a[e].url).html(a[e].caption);$(r).find(".simotelBtns").append(t)}}),$(t).append($("<div class='clrfx'>"));let d=$.notify({body:t,footer:r},{style:"simotel-caller-id"});$(d).turnOnHideTimer(e)}else{t=$("<div>"),clientName="بدون نام",n=$("<a>").attr("href","tel:"+e.participant).html(e.participant),$(t).append($("<div>").append(clientName)),$(t).append($("<div>").append(n));let i=$.notify({body:t},{style:"simotel-caller-id"});$(i).turnOnHideTimer(e)}}!function(e){e.fn.turnOnHideTimer=function(t){let n,i=popUpTimeMilliSeconds/100,o=e(this[0].body[0]).parents(".notifyjs-wrapper"),s=!1,l=()=>{i<1&&(o.find(".notifyjs-simotel-caller-id-base").css("background-color","#fa9393"),o.slideUp(1e3,function(){o.remove()}),clearInterval(n)),i--};n=setInterval(l,100),e(o).on("click",function(){s=!0,fixedPopups.add(t),o.find(".notifyjs-simotel-caller-id-base").addClass("fixed"),clearInterval(n),e(o).find(".countDownProgress").slideUp(150)}).on("mouseover",function(){e(o).find(".countDownProgress").css("animation-play-state","paused"),clearInterval(n)}).on("mouseleave",function(){e(o).find(".countDownProgress").css("animation-play-state","running"),n=s?null:setInterval(l,100)})}}(jQuery);const fixedPopups={add:function(e){let t=this.getCookie();t||(t=[]),this.numberExistsInHistory(e.participant)||(t.push(e),setCookie("FixedPopups",JSON.stringify(t),5))},getCookie:function(){let e=getCookie("FixedPopups");return e?JSON.parse(e):null},numberExistsInHistory:function(){},getAll:function(){return this.getCookie()}};var notifyScript=document.createElement("script");notifyScript.src=rootWebUrl+"/modules/addons/simotel/templates/js/notify.min.js",notifyScript.onload=function(){$.notify.addStyle("simotel-caller-id",{html:"<div class=''><div class='icon-holder'><img class='newcall-icon' src='"+addonUrl+"/templates/images/call-simotel-blue.png' /></div><div class='simotel-popup-body' data-notify-html='body'/><div class='simotel-popup-footer' data-notify-html='footer'/><div class='clrfx'><a class='closeNotify' ><strong>x</strong></a></div>"+`<div class='countDownProgress' style='animation: progressBarCountDown forwards linear ${popUpTime}s'><span></span></div>`}),$.notify.defaults(notifyOptions),$(document).on("click",".notifyjs-simotel-caller-id-base .closeNotify",function(){$(this).trigger("notify-hide")}),$(document).ready(function(){fixedPopups.getAll()})},document.head.appendChild(notifyScript);var notifyOptions={clickToHide:!1,autoHide:!1,autoHideDelay:popUpTimeMilliSeconds,arrowShow:!0,arrowSize:5,position:"bottom right",elementPosition:"bottom right",globalPosition:"bottom right",style:"bootstrap",className:"info",showAnimation:"slideDown",showDuration:400,hideAnimation:"slideUp",hideDuration:200,gap:5},cssId="simotelCss";if(!document.getElementById(cssId)){var head=document.getElementsByTagName("head")[0],link=document.createElement("link");link.id=cssId,link.rel="stylesheet",link.type="text/css",link.href=rootWebUrl+"/modules/addons/simotel/templates/css/simotel.min.css",link.media="all",head.appendChild(link)}function resetElHeight(e){let t=-1*$(e).height()-30;$(e).css({top:t+"px"})}function makeBalloon(e){return`<span class="simotelClickToDial">\n                <span class="balloon">\n                <div>${e}</div>\n                    <div style="text-align: center"> <a href="#"  data-number="${e}">ارسال تماس</a></div>\n                    <div class="status"></div>\n                    <span class="message"></span>                    \n                </span> \n                <span class="number">${e}</span>\n            </span>`}function addProfilesRow(e="",t="",n="",i=""){let o=$("form.module-configs table tbody tr").length,s=`\n            <tr>\n              <td>${o+1}</td>\n                <td><input type="text" name="simotelServerProfile[${o}][profile_name]" value="${e}" class="form-control">\n                </td>\n                <td><input dir="ltr" type="text" name="simotelServerProfile[${o}][server_address]" value="${t}"\n                           class="form-control"></td>\n                <td><input dir="ltr" type="text" name="simotelServerProfile[${o}][api_user]" value="${n}"\n                           class="form-control"></td>\n                <td><input dir="ltr" type="password" name="simotelServerProfile[${o}][api_pass]" value="${i}"\n                           class="form-control"></td>\n                <td><input dir="ltr" type="text" name="simotelServerProfile[${o}][context]" value="${i}"\n                           class="form-control"></td>\n                <td><a href="#" class="btn btn-danger btn-sm delete-row">حذف</a></td>           \n                           \n            </tr>               \n            `;$("form.module-configs tbody").append(s)}function setCookie(e,t,n){var i="";if(n){var o=new Date;o.setTime(o.getTime()+24*n*60*60*1e3),i="; expires="+o.toUTCString()}document.cookie=e+"="+(t||"")+i+"; path=/"}function getCookie(e){for(var t=e+"=",n=document.cookie.split(";"),i=0;i<n.length;i++){for(var o=n[i];" "==o.charAt(0);)o=o.substring(1,o.length);if(0==o.indexOf(t))return o.substring(t.length,o.length)}return null}function eraseCookie(e){document.cookie=e+"=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;"}clickToDialActive&&($("p ,td").each(function(){if($(this).find("textarea,input,a").length>0)return null;let e=$(this).html().replaceAll(phoneNumberRegx,makeBalloon);$(this).html(e)}),$("input[type=text],input[type=number],input[type=tel]").each(function(){let e=$(this).val().match(phoneNumberRegx);if(null!=e)for(let t in e){let n=makeBalloon(e[t]);$(n).insertAfter($(this))}}),$("body").on("click",function(e){$(e.target).parents(".simotelClickToDial").length>0||$(".simotelClickToDial").removeClass("active")}),$("body").on("click",".simotelClickToDial .number",function(){$(".simotelClickToDial").removeClass("active"),$(this).parent().addClass("active"),resetElHeight($(this).parent().find(".balloon"))}),$("body").on("click",".simotelClickToDial .balloon a",function(e){e.preventDefault();let t=$(this).parents(".balloon");function n(e,n){let i=$(t).find(".status");$(i).html(n),$(i).removeClass("error pending success"),$(i).addClass(e)}$(t).find(".message").html(""),n("pending","در حال ارسال تماس ..."),resetElHeight($(t)),$.get(adminPanelUrl+"/addonmodules.php?module=simotel&action=simotelCall&callee="+$(this).data("number")).done(e=>{1==e.success?n("success","با موفقیت ارسال شد."):(n("error","خطا در ارسال تماس."),$(t).find(".message").html(e.message))}).fail(e=>{n("error","خطا در ارسال تماس.")}).done(e=>{resetElHeight($(t))})})),$("document").ready(function(){$("form.module-configs #addProfile").click(function(e){e.preventDefault(),addProfilesRow()}),$("form.module-configs table").on("click"," a.delete-row",function(e){$(this).parents("tr").remove(),$("form.module-configs table tbody").find("tr").each(function(e,t){$(this).find("td:first").html(e+1)})}),$("form.module-configs").submit(function(e){e.preventDefault(),$("#saveModuleConfigsBtn").attr("disabled","disabled"),$.post($(this).attr("action"),$(this).serialize()).success(e=>{1==e.success&&alert("ذخیره شد.")}).done(function(){$("#saveModuleConfigsBtn").attr("disabled",!1)})})});
